<head>
	<title>Mapping US states with D3</title>
	<link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700%7CDroid+Sans:400,700%7CArvo:400,700" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/main.min.css?v=20150223a">
	<link rel="Shortcut Icon" href="http://wwwcache.wral.com/favicon.ico" />
	<script src="https://d3js.org/d3.v3.min.js" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="https://d3js.org/topojson.v1.min.js"></script>
	<style>
	pre, code {
		padding: 5px;
		background-color: #e9e9e9;
	}
	</style>
</head>
<body class="wral">
	<div class="g-wrap">
		<div class="container">
			<div class="1-default">
				<h2 style="margin-top:20px;">Mapping US states with D3</h2>

				<!-- BEGIN LEAFLET MAP -->
				<div id="leaflet-map" class="breakpoint-tablet-and-desktop-only" style="width: 100%; margin-top: 10px; margin-bottom: 10px; max-height: 500px;">&#160;</div>
				<!-- END LEAFLET MAP -->
				<p>A basic, clean D3 map for applications and illustrations about the U.S. using state shapefiles.</p>

				<h4 style="margin-top:20px;">Embed tag</h4>
				<pre>
<style type="text/css">
.us_state {
        fill:#f7f7f7;
        stroke:#a6a8ab;
        stroke-width:1;
}
.us_state:hover {
        stroke-width:3;
}
.selected {
        stroke-width:3;
        /*stroke:#6b6b6b;*/
}
select#state_select {
        height:40px;
        font-weight: bold;
        font-size: 16px;
}

#svg {
        width:100%;
        max-height: 100%;
}
svg {
    position: absolute;
    top: 0;
    left: 0;
}
.map_container {
    height: 0;
    padding-top: 65%;
    position: relative;
}
.maplegend {
        border:0;
        padding:0;
        text-align: center;
        font-size:12px;
        float:right;
        width:30px;
        height:15px;
        border-top:1px solid #a6a8ab;
        border-bottom:1px solid #a6a8ab;
}
.maplegend-a {
        border:0;
        padding:0;
        text-align: center;
        font-size:12px;
        float:right;
        width:30px;
        height:15px;
        border-top:1px solid #a6a8ab;
        border-left:1px solid #a6a8ab;
        border-bottom:1px solid #a6a8ab;
}
img#icon_inactive {
        opacity: 0.4;
        filter: alpha(opacity=40); /* For IE8 and earlier */
}
</style>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<div style="clear:both;">
        <select style="margin-top:10px;" id="state_select"> 
                <option value="Alabama">Alabama</option> 
                <option value="Alaska">Alaska</option> 
                <option value="Arizona">Arizona</option> 
                <option value="Arkansas">Arkansas</option> 
                <option value="California">California</option> 
                <option value="Colorado">Colorado</option> 
                <option value="Connecticut">Connecticut</option> 
                <option value="Delaware">Delaware</option>
                <option value="Florida">Florida</option> 
                <option value="Georgia">Georgia</option> 
                <option value="Hawaii">Hawaii</option> 
                <option value="Idaho">Idaho</option> 
                <option value="Illinois">Illinois</option> 
                <option value="Indiana">Indiana</option> 
                <option value="Iowa">Iowa</option> 
                <option value="Kansas">Kansas</option> 
                <option value="Kentucky">Kentucky</option> 
                <option value="Louisiana">Louisiana</option> 
                <option value="Maine">Maine</option> 
                <option value="Maryland">Maryland</option> 
                <option value="Massachusetts">Massachusetts</option> 
                <option value="Michigan">Michigan</option> 
                <option value="Minnesota">Minnesota</option> 
                <option value="Mississippi">Mississippi</option> 
                <option value="Missouri">Missouri</option> 
                <option value="Montana">Montana</option> 
                <option value="Nebraska">Nebraska</option> 
                <option value="Nevada">Nevada</option> 
                <option value="New Hampshire">New Hampshire</option> 
                <option value="New Jersey">New Jersey</option> 
                <option value="New Mexico">New Mexico</option> 
                <option value="New York">New York</option> 
                <option value="North Carolina" selected="selected">North Carolina</option> 
                <option value="North Dakota">North Dakota</option>
                <option value="Ohio">Ohio</option>  
                <option value="Oklahoma">Oklahoma</option> 
                <option value="Oregon">Oregon</option> 
                <option value="Pennsylvania">Pennsylvania</option> 
                <option value="Rhode Island">Rhode Island</option> 
                <option value="South Carolina">South Carolina</option> 
                <option value="South Dakota">South Dakota</option> 
                <option value="Tennessee">Tennessee</option> 
                <option value="Texas">Texas</option> 
                <option value="Utah">Utah</option> 
                <option value="Vermont">Vermont</option> 
                <option value="Virginia">Virginia</option> 
                <option value="Washington">Washington</option> 
                <option value="West Virginia">West Virginia</option> 
                <option value="Wisconsin">Wisconsin</option> 
                <option value="Wyoming">Wyoming</option>
        </select>
        <div id="map" style="margin-bottom:0px;"></div>
        <div style="margin:0;">
                <div style="margin:0;padding-top:0px;display:block;">
                        <div style="float:right;padding-bottom:30px;">
                                <div style="text-align:center;text-transform:uppercase;font-size:12px;padding:0;">% vulnerable</div>
                                <div>
                                        <div class="maplegend" style="background-color:#3182bd;"><br />18+</div>
                                        <div class="maplegend" style="background-color:#9ecae1;"><br />7-18</div>
                                        <div class="maplegend" style="background-color:#deebf7;"><br />3-7</div>
                                        <div class="maplegend-a" style="background-color:#eff3ff;"><br />0-3</div>
                                </div>
                        </div>
                </div>
                <div>
                        <h4 style="font-weight:300; margin-top:10px;line-height: 120%; color:#b7b7b7;">Vulnerable: <span style="color:#333;"><span id="vulnerable">6.45</span>%</span><br />
                                Medicaid expansion: <span style="color:#333;" id="med_expansion">No</span></h4>
                </div>
                <div style="width:300px;display:inline;float:left;font-size:18px; font-family:'Droid Sans',Helvetica,sans-serif;clear:both; color:#b7b7b7">
                        Vulnerable hospitals: <span id="vulnerable_hospitals" style="color:#333;">4</span>
                </div>
                <div style="width:300px;display:inline;float:left;font-size:18px; font-family:'Droid Sans',Helvetica,sans-serif; color:#b7b7b7">
                        Hospitals studied: <span id="total_hospitals" style="color:#333;">62</span>
                </div>
                <div style="clear:both;display:block;text-align: right; font-style: italic; font-size: 11px; color: rgb(171, 171, 171); font-family:'Droid Sans',Helvetica,sans-serif; padding:10px 0; position:relative;"><a href="http://data.ap.org/projects/2015/rural-hospitals/">Source: Associated Press</a></div>
                </div>
</div>
                                </pre>
				<br />
				<p style="margin-top:20px;"><b>Important: </b>Don't forget to enable embed on all platforms</p>

				<h4 style="margin-top:20px;">RequireJS Module</h4>
				<pre>
require(
  ['jquery','lodash','http://d3js.org/d3.v3.min.js','http://d3js.org/topojson.v1.min.js'],

  function($, _) {

    var state = "North_Carolina";
    var stats;
    var state_display = "North Carolina";

    //initial height and width recalculated
    var width = 600,
    height = 600;

    var projection = d3.geo.albersUsa()
    .scale(820)
    .translate([300,190]);

    var path = d3.geo.path()
    .projection(projection);

    //resizing from here: http://stackoverflow.com/questions/20885164/how-to-create-a-responsive-map-using-d3
    var svg = d3.select("#map")
    .append("div")
    .attr("id","svg")
    .append("div")
    .attr("class","map_container")
    .append("svg")
    .attr("viewBox","0 0 " + width + " " + height)
    .attr("preserveAspectRatio","xMinYMin");

    d3.json("/news/national_world/data_set/14437972/?dsi_id=states&version=jsonObj", function(error, us) {
      svg.selectAll(".us_state")
      .data(topojson.feature(us, us.objects.states).features)
      .enter().append("path")
      .attr("class", function(d) {
        if(d.properties.name == "North Carolina"){return "us_state " + d.properties.name + " selected"}
          else if(d.properties.name == "Puerto Rico"){return "hidden"}
            else{return "us_state"}
          })
      .attr("id", function(d) {return d.properties.name.split(' ').join('_')})
      .attr("d", path)
      .on("click", function(d) {
        d3.selectAll(".selected").classed("selected", false);
        d3.select(this).classed("selected", true);
        svg.selectAll("path").sort(function (a, b) { // select the parent and sort the path's
        if (a.id != d.id) return -1;               // a is not the hovered element, send "a" to the back
        else return 1;                             // a is the hovered element, bring "a" to the front
      });
      });
      run_rural();
      bindClicks();
    });

    //workaround for making sure path appears on top
    jQuery.fn.d3Click = function () {
      this.each(function (i, e) {
        var evt = document.createEvent("MouseEvents");
        evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
        e.dispatchEvent(evt);
      });
    };

    function run_rural(){
      var rural_stats = (function(){
        $.ajax({
          'async': true,
          'global': false,
          'url': 'news/national_world/data_set/14614951/?dsi_id=rural-hospitals&version=jsonObj',
          'dataType': "json",
          'success': function (data) {
            rural_stats = data;
            stats = rural_stats;
            parseData();
          }
        });
        return rural_stats;
      })();
    }

    function parseData(){
      for (j=0; j < stats.length; j++){
            vulnerable = parseFloat(stats[j]['Percent Vulnerable']);
            id_name = '#'+stats[j].State.replace(/ /g,"_");
            if (id_name == "#DC"){
              //ignore because there's no visible shapefile
            }
            else {
              switch (true){
                case (vulnerable < 3 ):
                  $(id_name).css('fill','#eff3ff');
                  break;
                case (vulnerable >= 3 && vulnerable < 7 ):
                  $(id_name).css('fill','#deebf7');
                  break;
                case (vulnerable >= 7 && vulnerable < 18 ):
                  $(id_name).css('fill','#9ecae1');
                  break;
                case (vulnerable >= 18 ):
                  $(id_name).css('fill','#3182bd');
                  break;
                default:
                  console.log("ERROR: no color category")
                  break;
              }
            }
            var i = 0;
            while(stats[i].State != state_display){
              i++;
            }
          }
    }

    //Event listeners for clicking path and select bar
    function bindClicks(){
      $('path').click(function(e){
        e.preventDefault();
        state = $(this).attr('id');
        state_display = state.replace(/_/g," ");
        $('#state_select').val(state_display);
        var i = 0;
        while(stats[i].State != state_display){
          i++;
        }
        document.getElementById("vulnerable").innerHTML = stats[i]['Percent Vulnerable'];
        document.getElementById("vulnerable_hospitals").innerHTML = stats[i]['Vulnerable Rural Hospitals'];
        document.getElementById("med_expansion").innerHTML = stats[i]['Medicaid Expansion'];
        document.getElementById("total_hospitals").innerHTML = stats[i]['Total Rural Hospitals Studied'];
      });
    }

    $('#state_select').change(function(e){
      e.preventDefault();
      state_display = $(this).val();
      state = state_display.replace(/ /g,"_");
      var i = 0;
      while(stats[i].State != state_display){
        i++;
      }
      $('path').attr('class','us_state');
      $('#'+ state).attr('class','us_state selected');
      document.getElementById("vulnerable").innerHTML = stats[i]['Percent Vulnerable'];
      document.getElementById("vulnerable_hospitals").innerHTML = stats[i]['Vulnerable Rural Hospitals'];
      document.getElementById("med_expansion").innerHTML = stats[i]['Medicaid Expansion'];
      document.getElementById("total_hospitals").innerHTML = stats[i]['Total Rural Hospitals Studied'];
      //Invoke d3 command for making sure path is properly shaded
      $('#'+state).d3Click();
    });

  }
);
				</pre>
			</div>
		</div>
	</div>

	<script>
		//INITIALIZE LEAFLET MAP
        var map = new L.Map('leaflet-map', {
        	center: new L.LatLng(35.1779935, -79.7731005),
        	zoom: 7,
        	scrollWheelZoom: false,
        	zoomControl: false
        });

        L.tileLayer('http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png', {
        	maxZoom: 13,
        }).addTo(map);
        //remove user pan option
        map.dragging.disable();
        //remove tile attribution
        map.attributionControl.setPrefix('');

        $.get('/data/nc-counties.json',function(counties){
        	var countyLayer;
        	countyLayer = L.geoJson(counties, {
        		style: countyStyle
        	}).addTo(map);

        	function countyStyle(feature) {
        		return {
        			"color": '#2594e3',
        			"weight": 3,
        			"opacity": 0.1,
        			"fillOpacity": 0.30
        		}
        	}
        });
	</script>
</body>